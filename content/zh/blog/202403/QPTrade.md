---
title:       "如何设计低延迟、高可用、高并发的交易服务技术方案"
description: "基于Disruptor、kafka、canal、mysql、zookeeper、spring-boot技术栈实现低延迟、高并发写、高可用的、交易服务状态机架构模式系统"
date:        2024-03-01
author:      "Devean"
image:       ""
math: true
categories:  ["Tech" ]
thumbnail: "/img/blog/QPTrade1.png"
tags:        ["系统设计"]

keywords: ["低延迟","高并发","高可用","系统设计"]
---

# 承兑服务设计方案


> 

## 需求背景
+ **现状：** BTC、ETH简选期权只能以BTC或ETH下单，而不能以稳定币USDT下单。

### 功能需求
+ 用户以USDT稳定币直接下单开仓期权。
+ 期权平仓后将BTC、ETH直接兑换为USDT划入用户账户。
### 非功能性需求
 + 低延迟(依赖交易服务市场撮合、故延迟越高、行情变化可能导致系统账户产生资损)
 + 高可用 (即服务不可宕机、升级发布尽可能不停机，重启部署可自动完全恢复)
 + 高并发（即交易行情到来时、多用户并发操作、用户间是并发的，不能排队处理）

## 业务流程
1. 用户在页面操作简选期权下单以USDT下单模式下单BTC简选期权。
2. 柜台报价接口传入BTC期权张数，柜台服务加上价差后调用资金账户返回所需USDT数量。
3. 用户下单BTC开仓期权张数,柜台以资金账户报价、扣除用户账户USDT,给用户开仓BTC简选期权，用户端开仓成功。
4. 服务端，柜台将BTC期权开仓订单记录以异步的方式同步给承兑服务、承兑服务完成后续的交易服务平账操作。
   + i. 承兑服务调用柜台服务接口完成换币系统账户加USDT、减BTC的操作。
   + ii. 承兑服务调用资金服务完成系统账户到资金账户的USDT划转。
   + iii. 承兑服务调用交易服务接口完成USDT换BTC的操作。
   + iv. 承兑服服务调用资金账户将换回的BTC划转值系统账户。
## 技术难点

1. 从柜台服务库夸系统低延迟交易订单同步至承兑服务后**不丢**、**不重**，Canal、Kafka**中间件集群异常需要容错处理。**
2. 柜台服务从用户账户完成减USDT、开仓BTC期权动作后,完成用户端交互。而承兑服务需要在极低延迟时间内需要完成后续平账的操作，因换币依赖于市场行情，延迟越高存在差价滑点的概率越高。
3. 承兑服务要完成平账操作,保证以下4次接口调用顺序性依赖、且多用户执行时多用户间并发性。
    + i. 承兑服务调用柜台服务接口完成换币系统账户加USDT、减BTC的操作。
    + ii. 承兑服务调用资金服务完成系统账户到资金账户的USDT划转。
    + iii. 承兑服务调用交易服务接口完成USDT换BTC的操作。
    + iv. 承兑服服务调用资金账户将换回的BTC划转值系统账户。
4. 服务迭代或异常重启部署、中间态的订单依旧可恢复完成剩余步骤，完成换币动作。
5. 为了避免正常停机导致订单延迟过高产生资损,服务升级需要不停机。

## 解决方案

### 柜台服务到承兑服务订单低延迟、高可用同步
1.  柜台服务加同步订单表、配置canal表同步，将该表同步写入kafka 
2.  承兑服务消费topic后解析Binlog、过滤非换币订单、将订单写入承兑服务同步订单表，以订单唯一id幂等校验。
3.  承兑服务入库后提交offset。随后将该订单放入Disruptor内存队列。
4.  服务启动后会启动定时任务，加载当前订单表每个shard最后一条记录的毫秒级时间戳、去查询柜台服务订单同步表对应的分片是存在未同步订单。 

TODO 小编正在编写中

### 状态机架构模式换成低延迟、高并发、高可靠平账流程


### 服务异常或迭代重启部署不停机






